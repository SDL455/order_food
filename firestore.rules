rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ──
    function isLoggedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isLoggedIn() && request.auth.uid == uid;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isLoggedIn() && getUserRole() == 'admin';
    }

    function isCustomer() {
      return isLoggedIn() && getUserRole() == 'customer';
    }

    // ── Users ──
    match /users/{uid} {
      // Anyone can read user profiles (for display names in chat, etc.)
      allow read: if true;
      // Only the user themselves can create/update their own document
      allow create: if isOwner(uid);
      allow update: if isOwner(uid);
      allow delete: if false;

      // Notifications subcollection
      match /notifications/{notiId} {
        allow read, write: if isOwner(uid);
      }
    }

    // ── Shops ──
    match /shops/{shopId} {
      // Anyone can read shops (guest browsing)
      allow read: if true;
      // Only admins can create a shop
      allow create: if isAdmin() && request.resource.data.ownerUid == request.auth.uid;
      // Only the shop owner can update their shop
      allow update: if isLoggedIn() &&
        resource.data.ownerUid == request.auth.uid;
      allow delete: if false;

      // ── Products (subcollection of shop) ──
      match /products/{productId} {
        // Anyone can read products (guest browsing)
        allow read: if true;
        // Only the shop owner can CUD products
        allow create, update, delete: if isLoggedIn() &&
          get(/databases/$(database)/documents/shops/$(shopId)).data.ownerUid == request.auth.uid;

        // ── Ratings (subcollection of product) ──
        match /ratings/{ratingUid} {
          // Anyone can read ratings
          allow read: if true;
          // Only logged-in users can write their own rating
          allow create, update: if isOwner(ratingUid);
          allow delete: if false;
        }
      }
    }

    // ── Orders ──
    match /orders/{orderId} {
      // Customer can read their own orders
      // Admin can read orders for their shop
      allow read: if isLoggedIn() && (
        resource.data.customerUid == request.auth.uid ||
        get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerUid == request.auth.uid
      );
      // Only logged-in customers can create orders
      allow create: if isLoggedIn() &&
        request.resource.data.customerUid == request.auth.uid;
      // Only the shop admin can update order status
      allow update: if isLoggedIn() &&
        get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerUid == request.auth.uid;
      allow delete: if false;
    }

    // ── Chats ──
    match /chats/{chatId} {
      // Only the customer or shop admin of the chat can read it
      allow read: if isLoggedIn() && (
        resource.data.customerUid == request.auth.uid ||
        get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerUid == request.auth.uid
      );
      // Logged-in users can create chats
      allow create: if isLoggedIn();
      // Participants can update (for lastMessage)
      allow update: if isLoggedIn() && (
        resource.data.customerUid == request.auth.uid ||
        get(/databases/$(database)/documents/shops/$(resource.data.shopId)).data.ownerUid == request.auth.uid
      );

      // ── Messages ──
      match /messages/{msgId} {
        // Only chat participants can read/write messages
        allow read, write: if isLoggedIn() && (
          get(/databases/$(database)/documents/chats/$(chatId)).data.customerUid == request.auth.uid ||
          get(/databases/$(database)/documents/shops/$(get(/databases/$(database)/documents/chats/$(chatId)).data.shopId)).data.ownerUid == request.auth.uid
        );
      }
    }
  }
}
